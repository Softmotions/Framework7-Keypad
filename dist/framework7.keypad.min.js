/**
 * Framework7 Keypad 1.0.3
 * Keypad plugin extends Framework7 with additional custom keyboards
 * 
 * http://www.idangero.us/framework7/plugins/
 * 
 * Copyright 2016, Vladimir Kharlampidi
 * The iDangero.us
 * http://www.idangero.us/
 * 
 * Licensed under MIT
 * 
 * Released on: February 19, 2016
 */

Framework7.prototype.plugins.keypad=function(e){"use strict";function a(e){t(e.container).find('input[type="numpad"], input[type="calculator"]').each(function(){var e=t(this);e[0].f7Keypad=new n({input:e,type:e.attr("type"),value:e.val()||0,valueMaxLength:e.attr("maxlength")||void 0,toolbar:"false"===e.attr("data-toolbar")?!1:!0,toolbarCloseText:e.attr("data-toolbarCloseText")||void 0})}),t(e.container).find(".numpad-init, .calculator-init").each(function(){var e,a=t(this);a.hasClass("calculator-init")&&(e="calculator"),a.hasClass("numpad-init")&&(e="numpad"),a[0].f7Keypad=new n({input:a.attr("data-input")||void 0,type:e,value:a.attr("data-value")||void 0,valueMaxLength:input.attr("maxlength")||void 0,toolbar:"false"===input.attr("data-toolbar")?!1:!0,toolbarCloseText:input.attr("data-toolbarCloseText")||void 0})})}var t=window.Dom7,n=(window.Template7,function(a){function n(){var a=!1;return o.params.convertToPopover||o.params.onlyInPopover?(!o.inline&&o.params.input&&(o.params.onlyInPopover?a=!0:e.device.ios?a=e.device.ipad?!0:!1:t(window).width()>=768&&(a=!0)),a):a}function s(){return o.opened&&o.container&&o.container.length>0&&o.container.parents(".popover").length>0?!0:!1}function p(e){if(e.preventDefault(),!o.opened&&(o.open(),o.params.scrollToInput&&!n())){var a=o.input.parents(".page-content");if(0===a.length)return;var t,s=parseInt(a.css("padding-top"),10),p=parseInt(a.css("padding-bottom"),10),r=a[0].offsetHeight-s-o.container.height(),l=a[0].scrollHeight-s-o.container.height(),i=o.input.offset().top-s+o.input[0].offsetHeight;if(i>r){var u=a.scrollTop()+i-r;u+r>l&&(t=u+r-l+p,r===l&&(t=o.container.height()),a.css({"padding-bottom":t+"px"})),a.scrollTop(u,300)}}}function r(e){s()||(o.input&&o.input.length>0?e.target!==o.input[0]&&0===t(e.target).parents(".picker-modal").length&&o.close():0===t(e.target).parents(".picker-modal").length&&o.close())}function l(){o.opened=!1,o.input&&o.input.length>0&&(o.input.parents(".page-content").css({"padding-bottom":""}),e.params.material&&o.input.trigger("blur")),o.params.onClose&&o.params.onClose(o),o.container.find(".picker-items-col").each(function(){o.destroyPickerCol(this)})}var o=this,i={type:"numpad",valueMaxLength:null,dotButton:!0,dotCharacter:".",buttons:function(){var e=a.dotCharacter||".";if("undefined"==typeof a.type||"numpad"===a.type){var t=void 0===a.dotButton?!0:a.dotButton;return[{html:'<span class="picker-keypad-button-number">1</span><span class="picker-keypad-button-letters"></span>',value:1},{html:'<span class="picker-keypad-button-number">2</span><span class="picker-keypad-button-letters">ABC</span>',value:2},{html:'<span class="picker-keypad-button-number">3</span><span class="picker-keypad-button-letters">DEF</span>',value:3},{html:'<span class="picker-keypad-button-number">4</span><span class="picker-keypad-button-letters">GHI</span>',value:4},{html:'<span class="picker-keypad-button-number">5</span><span class="picker-keypad-button-letters">JKL</span>',value:5},{html:'<span class="picker-keypad-button-number">6</span><span class="picker-keypad-button-letters">MNO</span>',value:6},{html:'<span class="picker-keypad-button-number">7</span><span class="picker-keypad-button-letters">PQRS</span>',value:7},{html:'<span class="picker-keypad-button-number">8</span><span class="picker-keypad-button-letters">TUV</span>',value:8},{html:'<span class="picker-keypad-button-number">9</span><span class="picker-keypad-button-letters">WXYZ</span>',value:9},{html:t?'<span class="picker-keypad-button-number">'+e+"</span>":"",value:t?e:void 0,dark:!0,cssClass:t?"":"picker-keypad-dummy-button"},{html:'<span class="picker-keypad-button-number">0</span>',value:0},{html:'<i class="icon icon-keypad-delete"></i>',cssClass:"picker-keypad-delete",dark:!0}]}return"calculator"===a.type?[{html:'<span class="picker-keypad-button-number">C</span>',value:"C",dark:!0},{html:'<span class="picker-keypad-button-number">±</span>',value:"±",dark:!0},{html:'<span class="picker-keypad-button-number">%</span>',value:"%",dark:!0},{html:'<span class="picker-keypad-button-number">÷</span>',value:"÷",cssClass:"calc-operator-button"},{html:'<span class="picker-keypad-button-number">7</span>',value:7},{html:'<span class="picker-keypad-button-number">8</span>',value:8},{html:'<span class="picker-keypad-button-number">9</span>',value:9},{html:'<span class="picker-keypad-button-number">×</span>',value:"×",cssClass:"calc-operator-button"},{html:'<span class="picker-keypad-button-number">4</span>',value:4},{html:'<span class="picker-keypad-button-number">5</span>',value:5},{html:'<span class="picker-keypad-button-number">6</span>',value:6},{html:'<span class="picker-keypad-button-number">-</span>',value:"-",cssClass:"calc-operator-button"},{html:'<span class="picker-keypad-button-number">1</span>',value:1},{html:'<span class="picker-keypad-button-number">2</span>',value:2},{html:'<span class="picker-keypad-button-number">3</span>',value:3},{html:'<span class="picker-keypad-button-number">+</span>',value:"+",cssClass:"calc-operator-button"},{html:'<span class="picker-keypad-button-number">0</span>',value:0,cssClass:"picker-keypad-button-double"},{html:'<span class="picker-keypad-button-number">.</span>',value:e},{html:'<span class="picker-keypad-button-number">=</span>',value:"=",cssClass:"calc-operator-button calc-operator-button-equal"}]:[]}(),closeByOutsideClick:!0,scrollToInput:!0,inputReadOnly:!0,convertToPopover:!0,onlyInPopover:!1,toolbar:!0,toolbarCloseText:"Done",toolbarTemplate:'<div class="toolbar"><div class="toolbar-inner"><div class="left"></div><div class="right"><a href="#" class="link close-picker">{{closeText}}</a></div></div></div>'};a=a||{};for(var u in i)"undefined"==typeof a[u]&&(a[u]=i[u]);o.params=a,o.cols=[],o.initialized=!1,o.inline=o.params.container?!0:!1;var c=(e.device.ios||navigator.userAgent.toLowerCase().indexOf("safari")>=0&&navigator.userAgent.toLowerCase().indexOf("chrome")<0&&!e.device.android,[]),d=[],v=!1;return o.calculator=function(e){function a(){for(var e="",a=0;a<d.length;a++){var n=d[a];a===d.length-1&&t.indexOf(n)>=0||n&&("."===n&&(n=0),e+=(n.toString()+"").replace("×","*").replace("÷","/"))}e=e.replace(/--/g,"+"),o.setValue(eval.call(window,e))}var t="+ - = × ÷ ± %".split(" "),n=[0,1,2,3,4,5,6,7,8,9,"."],s="C",p="±",r="%";if(o.value||(o.value=0),e===s)return o.setValue(0),c=[],void(d=[]);if(n.indexOf(e)>=0){if("."===e&&v&&o.value.toString().indexOf(".")>=0)return;o.setValue(t.indexOf(c[c.length-1])>=0?e:o.value?o.value+""+e:e),v=!0}if(t.indexOf(e)>=0)if(e===p){if("."===o.value)return;o.setValue(-1*o.value),v=!0}else if(e===r){if(d[d.length-2]){var l=o.value/100;o.setValue(d[d.length-2]*l)}v=!0}else{var i=d[d.length-1];if("="===e){if("="===d[d.length-1]){if(d.length<2)return;d.pop();var u=d[d.length-2],k=d[d.length-1];d.push(u),d.push(k)}else d.push(o.value);d.push("="),a()}else["-","+","×","÷","="].indexOf(i)>=0?("="===i&&(d=[o.value,e]),["-","+","×","÷"].indexOf(i)>=0&&(v?["-","+"].indexOf(i)>=0&&["×","÷"].indexOf(e)>=0?(d.push(o.value),d.push(e)):(d.push(o.value),d.push(e),a()):d[d.length-1]=e)):(d.push(o.value),d.push(e),a());v=!1}e!==p&&e!==r&&c.push(e)},o.triggerKeyDown=function(e){var a=t(o.input)[0];if(a){var n=new CustomEvent("keydown",{bubbles:!0,cancelable:!0});n.key=e,a.dispatchEvent(n)}},o.triggerKey=function(e){"string"!=typeof e&&(e=e.toString());var a=t(o.input)[0];if(a){var n=e.charCodeAt(0),s=new CustomEvent("keypress",{bubbles:!0,cancelable:!0});s.key=e,s.which=s.keyCode=s.charCode=n,a.dispatchEvent(s)}},o.setValue=function(e){o.updateValue(e)},o.updateValue=function(e){o.value=e,o.params.valueMaxLength&&o.value.length>o.params.valueMaxLength&&(o.value=o.value.substring(0,o.params.valueMaxLength)),o.params.onChange&&o.params.onChange(o,o.value),o.input&&o.input.length>0&&(t(o.input).val(o.params.formatValue?o.params.formatValue(o,o.value):o.value),t(o.input).trigger("change"))},o.initKeypadEvents=function(){function e(e){var n=t(e.target);if(n.hasClass("picker-keypad-button")||(n=n.parents(".picker-keypad-button")),0!==n.length){var s=o.params.buttons[n.index()],p=s.value,r=o.value,l=n.hasClass("picker-keypad-delete"),i=t(o.input)[0];"numpad"===o.params.type&&("undefined"==typeof r&&(r=""),l?r=r.substring(0,r.length-1):"undefined"!=typeof p&&("."===p&&r.indexOf(".")>=0&&(p=""),r+=p),i.hasAttribute("data-mask")?l?o.triggerKeyDown("Backspace"):null!=p&&""!==p&&o.triggerKey(p):"undefined"!=typeof r&&o.setValue(r)),"calculator"===o.params.type&&(o.calculator(s.value),a.find(".calc-operator-active").removeClass("calc-operator-active"),n.hasClass("calc-operator-button")&&!n.hasClass("calc-operator-button-equal")&&n.addClass("calc-operator-active")),"custom"===o.params.type,s.onClick&&s.onClick(o,s)}}var a=o.container.find(".picker-keypad-buttons");a.on("click",e),o.container[0].f7DestroyKeypadEvents=function(){a.off("click",e)}},o.destroyKeypadEvents=function(e){"f7DestroyKeypadEvents"in o.container[0]&&o.container[0].f7DestroyKeypadEvents()},o.buttonsHTML=function(){for(var e,a,t="",n=0;n<o.params.buttons.length;n++)a=o.params.buttons[n],e="picker-keypad-button",a.dark&&(e+=" picker-keypad-button-dark"),a.cssClass&&(e+=" "+a.cssClass),t+='<span class="'+e+'">'+(a.html||"")+"</span>";return t},o.layout=function(){var e="",a="",t=o.buttonsHTML();a="picker-modal picker-keypad picker-keypad-type-"+o.params.type+" "+(o.params.cssClass||""),e='<div class="'+a+'">'+(o.params.toolbar?o.params.toolbarTemplate.replace(/{{closeText}}/g,o.params.toolbarCloseText):"")+'<div class="picker-modal-inner picker-keypad-buttons">'+t+"</div></div>",o.pickerHTML=e},o.params.input&&(o.input=t(o.params.input),o.input.length>0&&(o.params.inputReadOnly&&o.input.prop("readOnly",!0),o.inline||o.input.on("click",p),o.params.inputReadOnly&&o.input.on("focus mousedown",function(e){e.preventDefault()}))),!o.inline&&o.params.closeByOutsideClick&&t("html").on("click",r),o.opened=!1,o.open=function(){var a=n();o.opened||(o.layout(),a?(o.pickerHTML='<div class="popover popover-picker-keypad"><div class="popover-inner">'+o.pickerHTML+"</div></div>",o.popover=e.popover(o.pickerHTML,o.params.input,!0),o.container=t(o.popover).find(".picker-modal"),t(o.popover).on("close",function(){l()})):o.inline?(o.container=t(o.pickerHTML),o.container.addClass("picker-modal-inline"),t(o.params.container).append(o.container)):(o.container=t(e.pickerModal(o.pickerHTML)),t(o.container).on("close",function(){l()})),o.container[0].f7Keypad=o,o.initKeypadEvents(),o.initialized?o.value&&o.setValue(o.value):o.params.value&&o.setValue(o.params.value),o.input&&o.input.length>0&&e.params.material&&o.input.trigger("focus")),o.opened=!0,o.initialized=!0,o.params.onOpen&&o.params.onOpen(o)},o.close=function(){return o.opened&&!o.inline?s()?void e.closeModal(o.popover):void e.closeModal(o.container):void 0},o.destroy=function(){o.close(),o.params.input&&o.input.length>0&&o.input.off("click focus",p),t("html").off("click",r)},o.inline&&o.open(),o});return e.keypad=function(e){return new n(e)},{hooks:{pageInit:a}}};